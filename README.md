# Описание тестового задания на позицию backend разработчика

## Цель
Нашему отделу пришла задача - считать зону покрытия сотовых вышек. 
- Фронтендерам нужно api для конвертации точек в полигоны с заданным радиусом.
- Аналитикам требуется в реальном времени отсматривать все поступающие запросы в гугл-таблице.

## Задача
Реализовать api-сервис на FastAPI. В нем должен быть метод, который на входе принимает координаты точки в системе EPSG:4326 и радиус в метрах, а на выходе дает GeoJSON с "круглым" полигоном (с соответствующим радиусом и центром в указанных координатах). При каждом вызове метода нужно заносить в гугл-таблицу информацию: дата и время вызова метода, координаты, радиус, площадь покрытия.

## Условия
1. Входящие данные должны валидироваться и оповещает клиент соответствующей ошибкой, если данные не прошли валидацию
2. Сделать имитацию, что это "долгий" запрос (время ответа >5с). При этом вызов с одного клиента не должен блокировать запрос для другого клиента
3. Запросы должны кэшироваться в базу данных postgres. Если запрос повторный - возвращаются данные из кэша без задержки
4. Гугл-таблица создается кандидатом с свободной форме, с настроенным доступом на просмотр.

## Ожидаемый результат
Форк этого репозитория на личном аккаунте github/gitlab кандидата. В нем должно быть описанное выше приложение python, которое будет готово к работе после развертывания виртуального окружения и установки зависимостей. Опционально - подготовить пакет к контейнеризации в docker

## Критерии оценки
Проверяться будет:
- работоспособность и соответствие ТЗ
- общий стиль кода (соблюдение PEP, базовых принципов программирования, документирование кода, наименование переменных и т.д.)


# GeoPolygon API

FastAPI приложение для создания полигонов покрытия сотовых вышек.

## Установка и запуск

### Предварительные требования

1. **PostgreSQL с расширением PostGIS**
   
   **Ubuntu/Debian:**
   ```bash
   sudo apt update
   sudo apt install postgresql postgresql-contrib postgis
   ```
   
   **macOS (с Homebrew):**
   ```bash
   brew install postgresql postgis
   ```
   
   **Windows:** Скачайте с официального сайта PostgreSQL

2. **Настройка PostgreSQL:**
   ```bash
   # Создайте пользователя и базу данных
   sudo -u postgres psql
   CREATE USER postgres WITH PASSWORD 'password';
   CREATE DATABASE geopolygon;
   GRANT ALL PRIVILEGES ON DATABASE geopolygon TO postgres;
   \q
   ```

### Установка приложения

1. Создайте виртуальное окружение:
```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
# или
venv\Scripts\activate  # Windows
```

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

3. Настройте переменные окружения:
```bash
cp env.example .env
# Отредактируйте .env файл с вашими настройками
```

4. Инициализируйте базу данных:
```bash
python init_db.py
```

5. Запустите приложение:
```bash
python main.py
```

Или через uvicorn:
```bash
uvicorn app.main:app --reload
```

### Запуск с Docker

1. **Установите Docker и Docker Compose**

2. **Запустите приложение:**
```bash
docker-compose up -d
```

3. **Проверьте логи:**
```bash
docker-compose logs -f app
```

4. **Остановите приложение:**
```bash
docker-compose down
```

## Настройка Google Sheets

1. Создайте проект в Google Cloud Console
2. Включите Google Sheets API
3. Создайте сервисный аккаунт и скачайте ключ в формате JSON
4. Поместите файл ключа в корень проекта как `service-account-key.json`
5. Создайте Google таблицу через API или вручную и укажите её ID в переменной `GOOGLE_SPREADSHEET_ID`

## API Endpoints

### Основные эндпоинты
- `GET /` - главная страница
- `GET /health` - проверка доступности сервиса
- `POST /polygon` - создание полигона покрытия

### Управление Google Sheets
- `POST /spreadsheet` - создание новой Google таблицы
- `GET /spreadsheet/url` - получение URL текущей таблицы

### Создание полигона

**POST** `/polygon`

**Тело запроса:**
```json
{
  "latitude": 55.7558,
  "longitude": 37.6176,
  "radius": 1000
}
```

**Ответ:**
```json
{
  "type": "Feature",
  "geometry": {
    "type": "Polygon",
    "coordinates": [[[...]]]
  },
  "properties": {
    "center": [37.6176, 55.7558],
    "radius": 1000,
    "area_sqm": 3141592.65,
    "cached": false
  }
}
```

### Создание Google таблицы

**POST** `/spreadsheet`

**Ответ:**
```json
{
  "spreadsheet_id": "1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms",
  "url": "https://docs.google.com/spreadsheets/d/1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms"
}
```

## Особенности реализации

- **Валидация**: координаты и радиус валидируются на входе
- **Асинхронность**: запросы не блокируют друг друга
- **Имитация долгого запроса**: новые запросы обрабатываются 5+ секунд
- **Логирование**: все запросы записываются в Google Sheets
- **Точная геометрия**: используется UTM проекция для создания точных круговых полигонов
- **Расчет площади**: площадь вычисляется в квадратных метрах

## Документация API

После запуска Swagger доступен по адресу: http://localhost:8000/docs 

## Ссылка на гугл таблицу с логами 
https://docs.google.com/spreadsheets/d/1RfBJV3OcWtf9M-jBxbkAXQsvUwpMvzHyjZRmwuIaM1Y/edit?usp=sharing

*ВАЖНАЯ ИНФОРМАЦИЯ*

Гугл может распознать, что мой ключ к апи утек в спободный доступ и заблочить его, 
Если такое произошло и интеграция с гугл таблицами не работает, 
Просьба написать мне, сегерю новый ключик